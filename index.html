<!DOCTYPE html>
<html>
	<head>
    <meta charset="utf-8" />
    <title>Game of Life</title>
    <style type="text/css" rel="stylesheet">
      .grid {
        display: table;
        border: 1px solid lightgrey;
      }

      .row {
        display: table-row;
      }

      .cell {
        display: table-cell;
        width: 10px;
        height: 10px;

        border: 1px solid lightgrey;
      }

      .cell.alive {
        background-color: black;
      }
    </style>
	</head>
	<body>
    <h1>Game of life</h1>
    <div id="mount"></div>

		<script>
      // Test utils

      var assert = function (predicate, message) {
        if (!predicate) {
          message = message || "Assertion Failed";

          throw new Error(message);
        }
      };

      // Game logic

      var toIndex = function (x, y, w, h) {
        if (x < 0 || x >= w || y < 0 || y >= h) {
          return undefined;
        }

        return y * w + x;
      };

      var isAlive = function (grid, x, y) {
        var index = toIndex(x, y, grid.width, grid.height);

        if (index !== undefined) {
          return grid.cells[index];
        }
      };

      var setAlive = function (grid, x, y) {
        var index = toIndex(x, y, grid.width, grid.height);

        if (index !== undefined) {
          grid.cells[index] = true;
        }
      };

      var newCells = function (width, height) {
        var cells = new Array(width * height);
        for (var cell = 0; cell < width * height; cell++) {
          cells[cell] = false;
        }

        return cells;
      };

      var newGrid = function (width, height) {
        width = width || 5;
        height = height || 5;

        return {
          width: width,
          height: height,
          cells: newCells(width, height),
        }
      };

      /*
       * Neighbors - Don't let cells go through walls.
       */
      var aliveNeighbors = function (grid, x, y) {
        var indices = [
          [x, y - 1],  // Left
          [x - 1, y - 1],  // Upper Left
          [x - 1, y],  // Upper
          [x - 1, y + 1],  // Upper Right
          [x, y + 1],  // Right
          [x + 1, y + 1],  // Bottom Right
          [x + 1, y],  // Bottom
          [x + 1, y - 1],  // Bottom Left
        ];

        return indices.filter(function (index) {
          var x = index[0],
              y = index[1];

          // Will also eliminate out of bound indices
          return isAlive(grid, x, y);
        }).length;
      };

      /*
       * Returns a new grid with the next generation
       */
      var update = function (grid) {
        var width = grid.width,
            height = grid.height;
        var nextGrid = newGrid(width, height);

        for (var y = 0; y < height; y++) {
          for (var x = 0; x < width; x++) {
            var alive = isAlive(grid, x, y);
            var neighbors = aliveNeighbors(grid, x, y);

            // - Any live cell with fewer than two live neighbors dies, as if
            //   caused by under-population
            // - Any live cell with two or three live neighbors lives on to the
            //   next generation
            // - Any live cell with more than three live neighbors dies, as if
            //   by over-population
            // - Any dead cell with exactly three live neighbors becomes a live
            //   cell, as if by reproduction
            if ((alive && (neighbors === 2 || neighbors === 3)) ||
                (!alive && neighbors === 3)) {
              setAlive(nextGrid, x, y);
            }
          }
        }

        return nextGrid;
      };

      var testToIndex = function () {
        var w = 5,
            h = 4;

        assert(toIndex(0, 0, w, h) === 0, "toIndex");
        assert(toIndex(1, 0, w, h) === 1, "toIndex");
        assert(toIndex(2, 0, w, h) === 2, "toIndex");
        assert(toIndex(2, 1, w, h) === 7, "toIndex");
        assert(toIndex(2, 3, w, h) === 17, "toIndex");
        assert(toIndex(4, 3, w, h) === 19, "toIndex");
        assert(toIndex(-1, 3, w, h) === undefined, "toIndex");
        assert(toIndex(1, -3, w, h) === undefined, "toIndex");
        assert(toIndex(1, 6, w, h) === undefined, "toIndex");
      };

      var testNewCells = function () {
        var grid = newGrid(3, 3);

        for (var y = 0; y < grid.height; y++) {
          for (var x = 0; x < grid.width; x++) {
            assert(!isAlive(grid, x, y), "New generated cells are dead");
          }
        }
      };

      var testAliveCell = function () {
        var grid = newGrid(3, 3);

        setAlive(grid, 0, 0);
        assert(isAlive(grid, 0, 0), "Cell should be alive");
      };

      var testAliveNeighbors = function () {
        var grid = newGrid(4, 3);

        setAlive(grid, 1, 0);
        setAlive(grid, 2, 0);
        setAlive(grid, 1, 1);
        setAlive(grid, 0, 2);
        setAlive(grid, 1, 2);

        assert(aliveNeighbors(grid, 0, 0) === 2, "Neighbors: 1, 5");
        assert(aliveNeighbors(grid, 1, 0) === 2, "Neighbors: 2, 5");
        assert(aliveNeighbors(grid, 2, 0) === 2, "Neighbors: 1, 5");
        assert(aliveNeighbors(grid, 3, 0) === 1, "Neighbors: 2");
        assert(aliveNeighbors(grid, 0, 1) === 4, "Neighbors: 1, 5, 9, 8");
        assert(aliveNeighbors(grid, 1, 1) === 4, "Neighbors: 1, 2, 9, 8");
        assert(aliveNeighbors(grid, 2, 1) === 4, "Neighbors: 1, 2, 9, 5");
        assert(aliveNeighbors(grid, 3, 1) === 1, "Neighbors: 2");
        assert(aliveNeighbors(grid, 0, 2) === 2, "Neighbors: 5, 9");
        assert(aliveNeighbors(grid, 1, 2) === 2, "Neighbors: 5, 8");
        assert(aliveNeighbors(grid, 2, 2) === 2, "Neighbors: 5, 9");
        assert(aliveNeighbors(grid, 3, 2) === 0, "Neighbors: none");
      };

      var testUpdateReproduction = function () {
        var grid = newGrid(3, 3);

        setAlive(grid, 1, 0);
        setAlive(grid, 0, 1);
        setAlive(grid, 2, 1);

        var next = update(grid);

        assert(isAlive(next, 1, 1),
          "Dead cell should become alive, caused by reproduction");
      };

      var testUpdateSurvival = function () {
        var grid = newGrid(3, 3);

        setAlive(grid, 0, 1);
        setAlive(grid, 1, 1);
        setAlive(grid, 2, 1);

        var next = update(grid);

        assert(isAlive(next, 1, 1),
          "Alive cell should stay alive, caused by survival");
      };

      var testUpdateDepopulation = function () {
        var grid = newGrid(3, 3);

        setAlive(grid, 1, 1);

        var next = update(grid);

        assert(!isAlive(next, 1, 1),
          "Alive cell should die, caused by depopulation");
      };

      var testUpdateOverCrowding = function () {
        var grid = newGrid(3, 3);

        setAlive(grid, 1, 0);
        setAlive(grid, 0, 1);
        setAlive(grid, 1, 1);
        setAlive(grid, 2, 1);
        setAlive(grid, 1, 2);

        var next = update(grid);

        assert(!isAlive(next, 1, 1),
          "Alive cell should die, caused by overcrowding");
      };

      console.log('Starting game logic tests');
      testToIndex();
      testNewCells();
      testAliveCell();
      testAliveNeighbors();
      testUpdateReproduction();
      testUpdateSurvival();
      testUpdateDepopulation();
      testUpdateOverCrowding();
      console.log('Game logic tests pass');

      // Rendering

      var cellToStr = function (alive) {
        return '<div class="cell' + (alive && ' alive' || '') + '"></div>';
      };

      var gridToStr = function (grid) {
        var gridStr = '<div class="grid">';

        for (var y = 0; y < grid.height; y++) {
          gridStr += '<div class="row">';
          for (var x = 0; x < grid.width; x++) {
            gridStr += cellToStr(isAlive(grid, x, y));
          }
          gridStr += '</div>';
        }

        gridStr += '</div>';
        return gridStr;
      };

      var render = function (grid, mount) {
        mount.innerHTML = gridToStr(grid);
      };

      var testDeadCellToStr = function () {
        var expected = '<div class="cell"></div>';
        var actual = cellToStr(false);

        assert(actual === expected, "Dead cell to string");
      };

      var testAliveCellToStr = function () {
        var expected = '<div class="cell alive"></div>';
        var actual = cellToStr(true);

        assert(actual === expected, "Alive cell to string");
      };

      var testGridToStr = function () {
        var grid = newGrid(2, 2);

        setAlive(grid, 0, 1);
        setAlive(grid, 1, 1);

        var expected = '<div class="grid">' +
          '<div class="row">' +
          '<div class="cell"></div>' +
          '<div class="cell"></div>' +
          '</div>' +
          '<div class="row">' +
          '<div class="cell alive"></div>' +
          '<div class="cell alive"></div>' +
          '</div>' +
          '</div>';
        var actual = gridToStr(grid);

        assert(actual === expected, "Grid to string");
      };

      var testRender = function () {
        var grid = newGrid(3, 3);
        var mount = {};

        var actual = render(grid, mount);
        var expectedGrid = gridToStr(grid);

        assert(mount.innerHTML === expectedGrid,
          "Should set mount's innerHTML property");
      };

      console.log('Starting rendering tests');
      testDeadCellToStr();
      testAliveCellToStr();
      testGridToStr();
      testRender();
      console.log('Rendering tests pass');

      // Game loop

      var Game = {
        mount: document.getElementById('mount'),

        start: function (grid) {
          render(grid, this.mount);

          this.lastGrid = grid;
          var next = update(grid);

          this.timeoutId = setTimeout(function () {
              this.start(next);
          }.bind(this), 200);
        },

        pauseGame: function () {
          clearTimeout(this.timeoutId);
        },

        resumeGame: function () {
          return this.start(this.lastGrid);
        },
      };

      // Gosper Glider Gun
      var gliderGrid = newGrid(50, 30);
      setAlive(gliderGrid, 1, 5);
      setAlive(gliderGrid, 2, 5);
      setAlive(gliderGrid, 1, 6);
      setAlive(gliderGrid, 2, 6);

      setAlive(gliderGrid, 35, 3);
      setAlive(gliderGrid, 36, 3);
      setAlive(gliderGrid, 35, 4);
      setAlive(gliderGrid, 36, 4);

      setAlive(gliderGrid, 11, 5);
      setAlive(gliderGrid, 11, 6);
      setAlive(gliderGrid, 11, 7);
      setAlive(gliderGrid, 12, 4);
      setAlive(gliderGrid, 12, 8);
      setAlive(gliderGrid, 13, 3);
      setAlive(gliderGrid, 13, 9);
      setAlive(gliderGrid, 14, 3);
      setAlive(gliderGrid, 14, 9);
      setAlive(gliderGrid, 15, 6);
      setAlive(gliderGrid, 16, 4);
      setAlive(gliderGrid, 16, 8);
      setAlive(gliderGrid, 17, 5);
      setAlive(gliderGrid, 17, 6);
      setAlive(gliderGrid, 17, 7);
      setAlive(gliderGrid, 18, 6);

      setAlive(gliderGrid, 21, 3);
      setAlive(gliderGrid, 21, 4);
      setAlive(gliderGrid, 21, 5);
      setAlive(gliderGrid, 22, 3);
      setAlive(gliderGrid, 22, 4);
      setAlive(gliderGrid, 22, 5);
      setAlive(gliderGrid, 23, 2);
      setAlive(gliderGrid, 23, 6);
      setAlive(gliderGrid, 25, 1);
      setAlive(gliderGrid, 25, 2);
      setAlive(gliderGrid, 25, 6);
      setAlive(gliderGrid, 25, 7);

      var trainGrid = newGrid(10, 18);
      setAlive(trainGrid, 5, 0);
      setAlive(trainGrid, 6, 1);
      setAlive(trainGrid, 2, 2);
      setAlive(trainGrid, 6, 2);
      setAlive(trainGrid, 3, 3);
      setAlive(trainGrid, 4, 3);
      setAlive(trainGrid, 5, 3);
      setAlive(trainGrid, 6, 3);

      setAlive(trainGrid, 2, 7);
      setAlive(trainGrid, 3, 8);
      setAlive(trainGrid, 4, 8);
      setAlive(trainGrid, 4, 9);
      setAlive(trainGrid, 4, 10);
      setAlive(trainGrid, 3, 11);

      setAlive(trainGrid, 5, 14);
      setAlive(trainGrid, 6, 15);
      setAlive(trainGrid, 2, 16);
      setAlive(trainGrid, 6, 16);
      setAlive(trainGrid, 3, 17);
      setAlive(trainGrid, 4, 17);
      setAlive(trainGrid, 5, 17);
      setAlive(trainGrid, 6, 17);

      Game.start(trainGrid);
    </script>
	</body>
</html>
